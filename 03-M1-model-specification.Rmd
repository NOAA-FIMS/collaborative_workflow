# M1 Model specification

This section describes the implementation of the modules in FIMS in
milestone 1. For the first milestone, we must implement enough
complexity to adequately test a very standard population model. For this
reason, we implement the minimum structure that can run the model
described in [Li et al. 2020](). The product will be an age-structured
integrated assessment model with two fleets (one survey, one fishery)
and two sexes.

## Model variables and bounds

## Inherited functors from `TMB`

### Atomic functions

Wherever possible, `FIMS` should not reinvent atomic functions with
extant definitions in `TMB`. If there is a need for a new atomic
function the development team can add it to `TMB` using the
`TMB_ATOMIC_VECTOR_FUNCTION()` macro following the instructions
[here](https://kaskr.github.io/adcomp/_book/AtomicFunctions.html#example-adding-new-primitive-function-with-known-derivatives).

### Statistical distributions

All of the statistical distributions needed for the first milestone of
`FIMS` are implemented in `TMB` and need not be replicated.
Code can be found [here](http://kaskr.github.io/adcomp/group__R__style__distribution.html).

|Distribution | Name|
| ------------|---------|
|Normal       |  [dnorm](http://kaskr.github.io/adcomp/dnorm_8hpp.html)|
|Multinomial  |  [dmultinom](http://kaskr.github.io/adcomp/group__R__style__distribution.html#gafd0ae6b53840267138bb9250115fbe8b)

#### Normal Distribution

$$f(y) = \frac{1}{\sigma\sqrt{2\pi}}exp\Bigg(-\frac{(x-\mu)^2}{2\sigma^2} \Bigg),$$

where $\mu$ is the mean of the distribution and $\sigma^2$ is the variance.

#### Multinomial Distribution

For $k$ categories and sample size, $n$,

$$f(y) = \frac{n!}{y_{1}!... y_{k}!}p^{y_{1}}_{1}...p^{y_{k}}_{k},$$

where $\sum^{k}_{i=1}y_{i} = n$, $p_{i} > 0$, and $\sum^{k}_{i=1}p_{i} = 1$.

The mean and variance of $y_{i}$ are respectively:

$\mu_{i} = np_{i}$,

$\sigma^{2}_{i} = np_{i}(1-p_{i})$

## Beverton-Holt expected recruitment function

For parity with existing stock assessment models, the first recruitment
option in FIMS is a Beverton-Holt [cite] parameterized with R0 and h.

$$R_t  =\frac{0.8R_0hS_{t-1}}{0.2R_0\phi_0(1-h) + S_{t-1}(h-0.2)}$$
Where $R_t$ and $S_t$ are mean recruitment and spawning biomass in time
$t$, $h$ is Mace-Doonan steepness, and $\phi_0$ are the unfished
spawning biomass per recruit. The initial FIMS model will implement a
static spawning biomass-per-recruit function, with the ability to
overload the method in the future to allow for time-variation in
mortality, maturity, and weight-at-age over time to account for changes
in spawning biomass per recruit. Deviations are assumed to be
lognormally distributed such that realized recruitment is the product of
mean recruitment and the exponentiated recruitment deviation.
$$R_t = R_t\mathrm{exp}(r_{dev,t}-R^2/2),   r_{dev,t} \sim N(0,R^2)$$

However, true $r_{dev,t}$ values are not known, so when using estimated
recruitment deviations $\hat{r_{dev,t}}$ the following equation is
applied to calculate mean unbiased recruitment $R*_t$ using a bias
adjustment factor $b_y=\frac{E[SD(ry)]^2}{\sigma_R^2}$ (Methot and
Taylor, 2011).
$$R^*_t=R_t\mathrm{exp}(\hat{r_{dev,t}}-b_y\frac{\sigma_R^2}{2})$$
The recruitment function should take as input the $R$ , $S$ values, the
$h$, $ln(R_0)$, and R parameters and $\phi_0$ and return mean and
realized recruitment.

## Logistic function with extensions
$$y_i=\frac{1}{1+\mathrm{exp}(-s *(x_i-\nu))}$$

Where $y_i$ is the quantity of interest (proportion mature, selected,
etc.), $i$ is the index (can be age or size or any other quantity),
$\nu$ is the index of 50% mature and where $s$ is the slope parameter 
from an alternative parameterization. Logistic functions for maturity 
and selectivity should inherit and extend upon the base logistic
function implementation.

The parameterization for the double logistic curve is specified as 
$$y_i=\frac{1}{1+\mathrm{exp}(-s_1 *(i-\nu_1))}$$

$$y_i=\frac{1.0}{ 1.0 + exp(-1.0 * s_1(i - \nu_1))} \left(1-\frac{1.0}{ 1.0 + exp(-1.0 * s_2 (i - \nu_2))}  \right)$$
Where $s_1$ and and $\nu_1$ are the slope and median (50%) parameters for the ascending limb of the curve, and $s_2$ and and $\nu_2$ are the slope and median parameters for the descending limb of the curve. This is currently only implemented for the selectivity module.

## Catch and fishing mortality

The Baranov catch equation relates catch to instantaneous fishing and
natural mortality.

$$ C_{f,a,t}=\frac{F_{f,a,t}}{F_{f,a,t}+M}(1-\mathrm{exp}(-(F_{f,a,t}+M)))N_{a,t}$$

Where $C_{f,a,t}$ is the catch at age $a$ at time $t$ for fleet $f$, $F$
is instantaneous fishing mortality, $M$ is assumed constant over ages
and time in the minimum viable assessment model, $N_a,t$ is the number
of age $a$ fish at time $t$.

$$F_{a,t}=\sum_{a=0}^A s_{a,f,t}F$$

$s_a,f$ is selectivity at age $a$ for fleet $f$. Selectivity-at-age is
constant over time.

Catch is in metric tons and survey is in number, so calculating catch
weight ($CW_t$) is done as follows:
$$ CW_t=\sum_{a=0}^A C_{a,t}w_a $$

Survey numbers are calculated as follows

$$I_t=q\sum_{a=0}^AN_{a,t}$$
Where $I_t$ is the survey index and $q_t$ is survey catchability at time
$t$.



## Modeling loops

This tier associates the expected values for each population section
associated with a data source to that data source using a likelihood
function. These likelihood functions are then combined into an objective
function that is passed to TMB.

The population loop will be initialized at a user-specified age, time
increment, and seasonal structure, rather than assuming ages, years, or
seasons follow any pre-defined structure. Population categories will be
described flexibly, such that subpopulations such as unique sexes,
stocks, species, or areas can be handled identically to reduce
duplication. Each subpopulation will have a unique set of attributes
assigned to it, such that each subpopulation can share or have a
different functional process (e.g. recruitment function, size-at-age)
than a different category.

Spawning time and recruitment time are user-specified and can occur more
than once per year. For the purposes of replicating model comparison
project outputs, in milestone 1, all processes including spawning and
recruitment occur January 1, but these should be specified via the
`spawn_time` and `recruit_time` inputs into FIMS to allow for future
flexibility. Spawning and recruitment timing can be input as a scalar or
vector to account for multiple options.

Within the population loop, matrices denoting population properties at
different partitions (age, season, sex) are translated into a single,
dimension-folded index. A lookup table is computed at model start so
that the dimension-folded index can be mapped to its corresponding
population partition or time partition (e.g. population(sex, area, age,
species, time, ...)) so the programmer can understand what is happening.
The model steps through each specified timestep to match the data to
expected values, and population processes occur in the closest specified
timestep to the user-input process timing (e.g. recruitment) across a
small timestep that is a predefined constant.

## Expected numbers and quantities

The expected values are calculated as follows in the population.hpp
file:
$$ B_t=\sum_{a=0}^AN_{a,t}w_a$$
where $B_t$ is total biomass in time $t$, $N$ is total numbers, $w_a$ is
weight-at-age $a$ in kilograms.

$$N_t=\sum_{a=0}^AN_{a,t}$$
where $N_t$ is the total number of fish in time $t$.


## Initial values

The initial equilibrium recruitment ($R_{eq}$) is calculated as follows:

$$R_{eq} = \frac{R_{0}(4h\phi_{F} - (1-h)\phi_{0})}{(5h-1)\phi_{F}} $$
where $\phi_{F}$ is the initial spawning biomass per recruitment given
fishing mortality.

## Likelihood calculations

Age composition likelihood links proportions at age from data to model
using a multinomial likelihood function. The multinomial and lognormal
distributions, including atomic functions are provided within `TMB`.

Survey index likelihood links estimated CPUE to input data CPUE in
biomass using a lognormal distribution. (model.hpp)

Catch index likelihood links estimated catch to input data catch in
biomass using a lognormal distribution. (model.hpp)

Age composition likelihoods link catch-at-age to expected catch-at-age
using a multinomial distribution.

## Statistical Inference:

TODO: Add description detailing the statistical inference used in M1
